<!--{% set threshold = 40 %}-->

<script>
  const callPythonFunctionLookUp = async (word, context) => {
    try {
      const response = await fetch(`http://localhost:5000/look-up-word?word=${word}&context=${context}`);
      return result = await response.json();
    } catch (error) {
      console.error(error);
    }
  };

  const callPythonFunctionSummarize = async (text) => {
    try {
      const response = await fetch(`http://localhost:5000/summarize?text=${text}`);
      return result = await response.json();
    } catch (error) {
      console.error(error);
    }
  };

  const callPythonFunctionExtractiveSummarize = async (text) => {
    try {
      const response = await fetch(`http://localhost:5000/extract-text?text=${text}`);
      return result = await response.json();
    } catch (error) {
      console.error(error);
    }
  };

  const callPythonFunctionAbstractiveSummarization = async (text) => {
    try {
      const response = await fetch(`http://localhost:5000/summarize?text=${text}`);
      return result = await response.json();
    } catch (error) {
      console.error(error);
    }
  };

  const callPythonFunctionSyntacticSimplification = async (text, prompt) => {
    try {
      const response = await fetch(`http://localhost:5000/syntactic-simplify?text=${text}&prompt=${prompt}`);
      return result = await response.json();
    } catch (error) {
      console.error(error);
    }
  };

  //
  async function syntacticSimplification() {
    //
    var dazzle = document.querySelector(".dazzle");
    var p = document.createElement("p");
    var p2 = document.createElement("p");

    //
    var text = document.createTextNode('Zinsbouw vereenvoudigen...');
    var prompt = document.createTextNode('...');
    p.appendChild(prompt);
    dazzle.appendChild(p);
    p2.appendChild(text);
    dazzle.appendChild(p2);

    //
    var selectedText = window.getSelection().toString();
    const response = await callPythonFunctionSyntacticSimplification(selectedText);
    prompt.nodeValue = JSON.stringify(response.prompt);
    text.nodeValue = JSON.stringify(response.result);
  }

  //
  document.addEventListener('DOMContentLoaded', () => {
    const spans = document.querySelectorAll('.word');
    spans.forEach((span) => {
      span.addEventListener('click', async (event) => {
        sentence_of_origin = span.closest('.sentence');
        var context = '';
        for (const child of sentence_of_origin.children) {
          context = context + ' ' + child.textContent;
        }

        const word = event.target.textContent;
        const response = await callPythonFunctionLookUp(word, context);
        var dazzle = document.querySelector(".dazzle");
        var p = document.createElement("p");
        var p2 = document.createElement("p");
        var text = document.createTextNode(JSON.stringify(response.result));
        var prompt = document.createTextNode(JSON.stringify(response.prompt));
        p.appendChild(prompt);
        dazzle.appendChild(p)
        p2.appendChild(text);
        dazzle.appendChild(p2);
      });
    });
  });


  //
  function insertAfter(newNode, existingNode) {
    console.log(newNode, existingNode);
    console.log(existingNode.parent, existingNode.nextSibling)
    existingNode.parentNode.insertBefore(newNode, existingNode.nextSibling);
  }


  // simplify sentence structure
  document.addEventListener('DOMContentLoaded', () => {
    const spans = document.querySelectorAll('.sentence');
    spans.forEach((span) => {
      span.addEventListener('click', async (event) => {
        sentence_of_origin = span.closest('.sentence');
        
        //
        var context = '';
        for (const child of sentence_of_origin.children) {
          context = context + ' ' + child.textContent;
        };

      
        //
        const response = await callPythonFunctionSyntacticSimplification(context);
        var p = document.createElement("p");
        newNode = document.createTextNode(JSON.stringify(response.result));
        
        //
        p.append(newNode);
        insertAfter(p, span);

        //
        sentence_of_origin.innerHTML = '<del>' + context + '</del>';
        parent = sentence_of_origin.parent;

      })
    })
  })

  async function extractiveSummarization() {
    //
    var selectedText = window.getSelection().toString();
    if (selectedText === "") {
      selectedText = document.body.innerText;
    }

    // dazzle ->  p-> prompt; p2 -> text
    var dazzle = document.querySelector(".dazzle");
    var p = document.createElement("p");
    var p2 = document.createElement("p");

    //
    var prompt = document.createTextNode('Kernzinnen ophalen...');
    var text = document.createTextNode('...');

    //
    p.appendChild(prompt);
    dazzle.appendChild(p);
    p2.appendChild(text);
    dazzle.appendChild(p2);

    //
    const response = await callPythonFunctionExtractiveSummarize(selectedText);
    prompt.nodeValue = 'Kernzinnen uit geselecteerde tekst...';
    text.nodeValue = JSON.stringify(response.result);
  }

  //
  async function abstractiveSummarization() {
    var selectedText = window.getSelection().toString();
    const response = await callPythonFunctionAbstractiveSummarization(selectedText);
    var dazzle = document.querySelector(".dazzle");
    var p = document.createElement("p");
    var p2 = document.createElement("p");
    var text = document.createTextNode(JSON.stringify(response.result));
    var prompt = document.createTextNode(JSON.stringify(response.prompt));
    p.appendChild(prompt);
    dazzle.appendChild(p)
    p2.appendChild(text);
    dazzle.appendChild(p2);
  }

  //
  async function emptyChat() {
    const dazzleDiv = document.querySelector('.dazzle');
    dazzleDiv.innerHTML = '';
  }
</script>

<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="..\static\css\style.css">
  <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <title>Teksten vereenvoudigen: prototype</title>
</head>

<body>
  {% for kw in keywords %}
  <span class="keyword">{{ kw }}</span>
  {% endfor %}

  <div class="container">
    <div class="text-container">
      {% for page in pdf %}
      <div class="page">
        <h1>{{page[1]}}</h1>
        {% for paragraph in page[0] %}
        <p>
          {% for sentence in paragraph %}
          <span class="sentence">
            {% for word in sentence %}
            <span class="word">{{word}}</span>
            {% endfor %}
          </span>
          {% endfor %}
        </p>
        {% endfor %}
      </div>
      {% endfor %}
    </div>

    <!--'chatbot'-->
    <div class="fixed-bottom">
      <div class="buttons">
        <input type="button" value="Schrijf dit eenvoudiger." onmousedown="syntacticSimplification()">
        <input type="button" value="Wat zijn de belangrijkste zinnen?" onmousedown="extractiveSummarization()">
        <input type="button" value="Parafraseer dit" onmousedown="abstractiveSummarization()">
        <button id="explainWord" class="btn"><i class="fa fa-book"></i></button>
        <button class="btn" onmousedown="emptyChat()"><i class="fa fa-trash"></i></button>
      </div>

      <!--append-div-->
      <div class="dazzle"></div>
    </div>
  </div>
</body>


<script>
  const toggleLookupButton = document.getElementById('explainWord');
  toggleLookupButton.addEventListener('click', () => {
    toggleLookupButton.classList.toggle('active');
  });

  toggleLookupButton.addEventListener("change", function () {
    console.log('change')
  });

</script>

</html>